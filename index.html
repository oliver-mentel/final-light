<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Tee Time Calculator</title>
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⛳</text></svg>">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            background: #f0f4fb;
            color: #2d3748;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 600px;
            margin: 60px auto;
            padding: 40px;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .container:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        h1 {
            color: #1a202c;
            font-size: 2.5em;
            margin-bottom: 24px;
            font-weight: 700;
            text-align: center;
        }

        .section {
            margin-bottom: 48px;
        }

        .section-title {
            margin: 30px 0 15px;
            font-weight: 700;
            color: #1a202c;
            font-size: 1.5em;
            text-align: center;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            position: relative;
            gap: 8px;
        }

        .label {
            color: #2c5282;
            font-weight: 600;
            font-size: 1em;
            flex-shrink: 0;
        }

        .value {
            color: #2d3748;
            font-size: 1em;
            font-weight: 400;
        }

        select, button, input[type="text"] {
            padding: 12px 16px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #edf2f7;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        select:focus, input[type="text"]:focus {
            background-color: #e2e8f0;
            box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.5);
            outline: none;
        }

        button {
            background-color: #3182cf;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            width: fit-content;
            align-self: center;
        }

        button:hover {
            background-color: #2b6cb0;
            transform: translateY(-2px);
        }

        hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 30px 0;
        }

        .last-tee-time {
            background-color: #ebf8ff;
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            margin-top: 32px;
            transition: background-color 0.3s;
        }

        .last-tee-time:hover {
            background-color: #d1eaf8;
        }

        .last-tee-time-label {
            font-size: 1.5em;
            color: #2b6cb0;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .last-tee-time-value {
            font-size: 2.4em;
            color: #2c5282;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.7em;
            }

            .section-title {
                font-size: 1.3em;
            }
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .suggestions li {
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .suggestions li:hover {
            background-color: #e2e8f0;
        }

        .location-input-container {
            position: relative;
            width: 100%;
        }

        input[type="checkbox"] {
            margin-left: auto;
            margin-right: 0;
            accent-color: #3182ce;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
<div class="container">
    <h1>⛳ Last Tee Time Calculator</h1>
    <div class="section">
        <div class="row">
            <span class="label">Golf Course Location:</span>
            <div class="location-input-container">
                <input type="text" id="locationSearch" placeholder="City nearest to golf course" autocomplete="off">
                <ul id="suggestions" class="suggestions"></ul>
            </div>
        </div>
        <div class="row">
            <button id="setLocationBtn">Set Location</button>
        </div>
        <div class="row">
            <span class="label">Number of Holes:</span>
            <select id="holeCount">
                <option value="18">18 Holes</option>
                <option value="9">9 Holes</option>
            </select>
        </div>
        <div class="row">
            <span class="label">Flight Size:</span>
            <select id="flightSize">
                <option value="1">1 Person</option>
                <option value="2">2 People</option>
                <option value="3">3 People</option>
                <option value="4">4 People</option>
            </select>
        </div>
        <div class="row">
            <span class="label">Include Twilight Time:</span>
            <input type="checkbox" id="includeTwilight">
        </div>
        <div class="row">
            <span class="label">Time Format:</span>
            <input type="checkbox" id="timeFormat" name="timeFormat" checked>
            <span id="formatLabel">24H</span>
        </div>
    </div>
    <hr>
    <div class="section">
        <h2 class="section-title">Location Information</h2>
        <div class="row"><span class="label">Location:</span> <span id="location" class="value">Not set</span></div>

        <h2 class="section-title">Date & Time Info</h2>
        <div class="row"><span class="label">Today's date:</span> <span id="today" class="value"></span></div>
        <div class="row"><span class="label">Sunset:</span> <span id="sunset" class="value"></span></div>
        <div class="row"><span class="label">Civil twilight end:</span> <span id="twilightEnd" class="value"></span></div>

        <h2 class="section-title">Play Details</h2>
        <div class="row"><span class="label">Time per hole:</span> <span id="timePerHole" class="value"></span></div>
        <div class="row"><span class="label">Total round time:</span> <span id="totalRoundTime" class="value"></span></div>
    </div>

    <div class="last-tee-time">
        <div class="last-tee-time-label">Last Tee Time</div>
        <div id="lastTeeTime" class="last-tee-time-value">--:--</div>
    </div>
</div>
<script>
    const sunriseSunsetApiBase = "https://api.sunrise-sunset.org/json";
    let lat, lng, timezone;
    let cachedTimezoneData = null;

    let timeZoneDbApiKey = "B3VY8R50KIYD";

    // DOM element references
    const locationSearchEl = document.getElementById('locationSearch');
    const suggestionsEl = document.getElementById('suggestions');
    const setLocationBtnEl = document.getElementById('setLocationBtn');

    async function fetchTimeZone(latitude, longitude) {
        if (cachedTimezoneData) return cachedTimezoneData;

        const url = `https://api.timezonedb.com/v2.1/get-time-zone?key=${timeZoneDbApiKey}&format=json&by=position&lat=${latitude}&lng=${longitude}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.status === "OK") {
                cachedTimezoneData = data.zoneName;
                return data.zoneName;
            } else {
                console.error('Error fetching time zone:', data.message);
                return null;
            }
        } catch (error) {
            console.error('Error fetching time zone:', error);
            return null;
        }
    }

    function formatTime(dateStr, use24HourFormat) {
        const date = new Date(dateStr);

        // Extract hours and minutes directly from the date object
        let hours = date.getUTCHours();
        let minutes = date.getUTCMinutes().toString().padStart(2, '0');

        if (use24HourFormat) {
            return `${hours}:${minutes}`;
        } else {
            let hours12 = hours % 12;
            hours12 = hours12 ? hours12 : 12;
            const ampm = hours >= 12 ? 'PM' : 'AM';
            return `${hours12}:${minutes} ${ampm}`;
        }
    }

    function formatDate(isoStr) {
        const date = new Date(isoStr);
        return `${String(date.getDate()).padStart(2, '0')}.${String(date.getMonth() + 1).padStart(2, '0')}.${date.getFullYear()}`;
    }

    function formatDuration(minutes) {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        return `${hours}h ${remainingMinutes}min`;
    }

    async function fetchSunData(date) {
        const url = `${sunriseSunsetApiBase}?lat=${lat}&lng=${lng}&date=${date}&formatted=0`;
        const response = await fetch(url);
        const data = await response.json();

        // Get the results which are in UTC
        const results = data.results;

        // Convert UTC times to the location's timezone
        const sunsetUTC = new Date(results.sunset);
        const twilightEndUTC = new Date(results.civil_twilight_end);

        // Calculate the time offset between UTC and location time in minutes
        // We'll use the timezone API data for this
        const timezoneResponse = await fetch(
            `https://api.timezonedb.com/v2.1/get-time-zone?key=${timeZoneDbApiKey}&format=json&by=position&lat=${lat}&lng=${lng}`
        );
        const timezoneData = await timezoneResponse.json();
        const gmtOffset = timezoneData.gmtOffset;

        // Adjust the sunset and twilight end times to the location's timezone
        const sunsetLocal = new Date(sunsetUTC.getTime() + (gmtOffset * 1000));
        const twilightEndLocal = new Date(twilightEndUTC.getTime() + (gmtOffset * 1000));

        return {
            sunset: sunsetLocal.toISOString(),
            civil_twilight_end: twilightEndLocal.toISOString()
        };
    }

    function calculatePlayTime(holes, flightSize) {
        const baseTime9Holes = 135;
        const baseTime18Holes = 255;
        const timeSavingsPerHole = {
            1: 3,
            2: 2,
            3: 1
        };
        const baseTime = holes === 9 ? baseTime9Holes : baseTime18Holes;
        const timeSaved = (flightSize < 4) ? timeSavingsPerHole[flightSize] * holes : 0;
        return baseTime - timeSaved;
    }

    function subtractMinutes(dateStr, minutes) {
        const date = new Date(dateStr);
        return new Date(date.getTime() - minutes * 60000).toISOString();
    }

    function roundToNext10Minutes(dateStr) {
        const date = new Date(dateStr);
        // Get hours in local time
        let hours = date.getHours();
        let minutes = date.getMinutes();

        // Round down to the nearest 10 minutes
        minutes = Math.floor(minutes / 10) * 10;

        // Set the rounded time
        date.setHours(hours);
        date.setMinutes(minutes);
        date.setSeconds(0);
        date.setMilliseconds(0);

        return date.toISOString();
    }

    async function searchLocation() {
        const query = locationSearchEl.value;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.length > 0) {
                lat = data[0].lat;
                lng = data[0].lon;
                timezone = await fetchTimeZone(lat, lng);
                if (!timezone) {
                    timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    console.warn('Failed to fetch timezone, using local timezone as fallback.');
                }
                document.getElementById("location").textContent = data[0].display_name;
                saveLocationToStorage(data[0].display_name, lat, lng, timezone);
                await calculateLastTeeTime();
            } else {
                alert('Location not found. Please try again.');
            }
        } catch (error) {
            console.error('Error searching location:', error);
            alert('An error occurred while searching for the location. Please try again.');
        }
    }

    async function calculateLastTeeTime() {
        if (!lat || !lng || !timezone) {
            alert('Please set a location first.');
            return;
        }

        const use24HourFormat = document.getElementById("timeFormat").checked;
        const today = new Date().toISOString().split("T")[0];
        const todayData = await fetchSunData(today);

        document.getElementById("today").textContent = formatDate(today);
        document.getElementById("sunset").textContent = formatTime(todayData.sunset, use24HourFormat);
        document.getElementById("twilightEnd").textContent = formatTime(todayData.civil_twilight_end, use24HourFormat);

        const holes = parseInt(document.getElementById("holeCount").value);
        const flightSize = parseInt(document.getElementById("flightSize").value);
        const includeTwilight = document.getElementById("includeTwilight").checked;

        const playTimeMinutes = calculatePlayTime(holes, flightSize);
        const timePerHole = Math.round(playTimeMinutes / holes);

        document.getElementById("timePerHole").textContent = `${timePerHole}min`;
        document.getElementById("totalRoundTime").textContent = formatDuration(playTimeMinutes);

        let endTimeStr = includeTwilight ? todayData.civil_twilight_end : todayData.sunset;
        let lastTeeTimeStr = subtractMinutes(endTimeStr, playTimeMinutes);

        lastTeeTimeStr = roundToNext10Minutes(lastTeeTimeStr);

        document.getElementById("lastTeeTime").textContent = formatTime(lastTeeTimeStr, use24HourFormat);
    }

    async function handleLocationInput() {
        const query = locationSearchEl.value.trim();
        if (query.length < 3) {
            suggestionsEl.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();
            displaySuggestions(data);
        } catch (error) {
            console.error('Error fetching location suggestions:', error);
        }
    }

    function displaySuggestions(suggestions) {
        suggestionsEl.innerHTML = '';
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.textContent = suggestion.display_name;
            li.addEventListener('click', async () => {
                locationSearchEl.value = suggestion.display_name;
                suggestionsEl.innerHTML = '';
                lat = suggestion.lat;
                lng = suggestion.lon;
                timezone = await fetchTimeZone(lat, lng);
                if (!timezone) {
                    timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    console.warn('Failed to fetch timezone, using local timezone as fallback.');
                }
                saveLocationToStorage(suggestion.display_name, suggestion.lat, suggestion.lon, timezone);
                document.getElementById("location").textContent = suggestion.display_name;
                await calculateLastTeeTime();
            });
            suggestionsEl.appendChild(li);
        });
    }

    function saveLocationToStorage(locationName, latitude, longitude, tz) {
        const locationData = {
            display_name: locationName,
            lat: latitude,
            lng: longitude,
            timezone: tz
        };
        localStorage.setItem('golfLocation', JSON.stringify(locationData));
    }

    function loadLocationFromStorage() {
        const storedLocation = localStorage.getItem('golfLocation');
        if (storedLocation) {
            const locationData = JSON.parse(storedLocation);
            lat = locationData.lat;
            lng = locationData.lng;
            timezone = locationData.timezone;
            document.getElementById("location").textContent = locationData.display_name;
            calculateLastTeeTime();
        }
    }

    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Event listeners
    locationSearchEl.addEventListener('input', debounce(handleLocationInput, 300));
    setLocationBtnEl.addEventListener('click', searchLocation);

    document.getElementById("timeFormat").addEventListener('change', () => {
        calculateLastTeeTime();
        document.getElementById("formatLabel").textContent = document.getElementById("timeFormat").checked ? "24H" : "12H";
    });

    document.getElementById("includeTwilight").addEventListener('change', calculateLastTeeTime);
    document.getElementById("holeCount").addEventListener('change', calculateLastTeeTime);
    document.getElementById("flightSize").addEventListener('change', calculateLastTeeTime);

    document.addEventListener('click', function (e) {
        if (e.target !== locationSearchEl && e.target !== suggestionsEl) {
            suggestionsEl.innerHTML = '';
        }
    });

    // Initial setup
    document.addEventListener('DOMContentLoaded', loadLocationFromStorage);
</script>
</body>
</html>
